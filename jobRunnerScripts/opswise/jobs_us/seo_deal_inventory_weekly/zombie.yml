populate_weekly_results:
  class: SQLExecute
  configuration:
    db:
      adapter: Teradata
      dsn: tdwc_dsn
    sql: |
      insert into sandbox.kb_seo_deal_inventory_weekly(datekey, url, deal_count, merchant_count, merchant_with_desc)
          select ${date_key},
                 url,
                 cast(sum(deal_count) as decimal(10,2))/7 as deal_count,
                 cast(sum(merchant_count) as decimal(10,2))/7 as merchant_count,
                 cast(sum(merchant_with_desc) as decimal(10,2))/7 as merchant_with_desc
          from sandbox.kb_seo_deal_inventory
          where cast('${date_value}' as Date)-7 < cast(datekey - 19000000 as Date format 'yyyy-mm-dd') and
                cast('${date_value}' as Date)+1 > cast(datekey - 19000000 as Date format 'yyyy-mm-dd')
          group by url;
