prepare_workflow_dates:
  class: ScriptTask
  emits:
    - date_key
    - date_value
  configuration:
    script: |
      LAST_RUN=$(tdsql 'select max(event_day_key) from sandbox.as_int_bld_session_1st_pv_fcs where event_day_key >= 20150301')
      NEXT_DATEKEY=$(date -d "$LAST_RUN 1 day" +%Y%m%d)
      NEXT_DATEVALUE=$(date -d "$LAST_RUN 1 day" +%Y-%m-%d)
      echo "{'date_key': '$NEXT_DATEKEY', 'date_value': '$NEXT_DATEVALUE'}"

check_billings_ini_successful:
  class: SQLRead
  dependencies:
    - prepare_workflow_dates
  settings:
    attempts: 60
    cooldown: 900
  configuration:
    db:
      adapter: Teradata
      dsn: tdwb_dsn
    sql:
      - select count(*) as row_count from dwh_mart_view.v_billings_ini_successful where cast(cast(created_at as date) as integer)+19000000 = ${date_key};
  assertions:
    - expression: ${row_count} > 110000
      fail: true

check_fact_clickstream:
  class: SQLRead
  dependencies:
    - prepare_workflow_dates
  settings:
    attempts: 60
    cooldown: 900
  configuration:
    db:
      adapter: Teradata
      dsn: tdwb_dsn
    sql:
      - select count(*) as row_count from dwh_mart_view.fact_clickstream where event_date = '${date_value}';
  assertions:
    - expression: ${row_count} > 15000000
      fail: true

truncate_teradata_table:
  class: SQLExecute
  dependencies:
    - check_billings_ini_successful
    - check_fact_clickstream
  configuration:
    db:
      adapter: Teradata
      dsn: tdwb_dsn
    sql:
     - delete from sandbox.as_int_bld_session_metrics_fcs where event_day_key = ${date_key};

load_int_bld_session_table_fcs:
  class: SQLExecute
  dependencies:
    - truncate_teradata_table
  configuration:
    db:
      adapter: Teradata
      dsn: tdwb_dsn
    sql_file: load_int_bld_session_table_fcs.sql

truncate_mysql:
  class: SQLExecute
  dependencies:
    - check_billings_ini_successful
    - check_fact_clickstream
  configuration:
    db:
      adapter: Mysql
      dsn: seo_analytics_dsn
    sql:
     - delete from seo_analytics.int_bld_session_metrics_fcs where event_day_key = ${date_key};

create_int_rp_cube:
  class: ScriptTask
  dependencies:
    - load_int_bld_session_table_fcs
  configuration:
    script: zombie_runner run ${base_dir}/opswise/jobs_intl/seo_int_request_path_cube --context=date_value:${date_value},date_key:${date_key}

load_mysql:
  class: ScriptTask
  dependencies:
    - truncate_mysql
    - load_int_bld_session_table_fcs
  configuration:
    script: /home/juicer/groupon-seo-admin/script/copy_subset_to_mysql as_int_bld_session_metrics_fcs event_day_key ${date_key} ${date_key} int_bld_session_metrics_fcs

create_seo_int_operational_cube:
  class: SQLExecute
  dependencies:
    - load_mysql
  configuration:
    db:
      adapter: Mysql
      dsn: seo_analytics_dsn
    sql_file: seo_int_operational_cube.sql
