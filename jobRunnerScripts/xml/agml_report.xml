<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<Knowledge_base>
    
    <job name="prepare seo deal inventory" type="executeBash" 
         command="./shell/agml_report.sh" 
            region="na">
    </job>
    
   <job name="dropTable log" type="dropTable" command="agml_merchants_report_tmp_log" 
         region="na" connectionType="teradata" onerror="ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="dropTable UV" type="dropTable" command="agml_merchants_report_tmp_UV" 
         region="na" connectionType="teradata" onerror="ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="dropTable ET" type="dropTable" command="agml_merchants_report_tmp_ET" 
         region="na" connectionType="teradata" onerror="ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="dropTable temp" type="dropTable" command="agml_merchants_report_tmp" 
         region="na" connectionType="teradata" onerror="ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>

    <job name="create temp table temp" type="executeSimpleQuery" 
         command='CREATE MULTISET TABLE sandbox.agml_merchants_report_tmp ,NO FALLBACK ,
                    NO BEFORE JOURNAL,
                    NO AFTER JOURNAL,
                    CHECKSUM = DEFAULT,
                    DEFAULT MERGEBLOCKRATIO
                    (
                     url VARCHAR(256) CHARACTER SET UNICODE CASESPECIFIC,
                     name VARCHAR(256) CHARACTER SET UNICODE CASESPECIFIC,
                     address VARCHAR(256) CHARACTER SET UNICODE CASESPECIFIC,
                     city VARCHAR(128) CHARACTER SET UNICODE CASESPECIFIC,
                     category VARCHAR(256) CHARACTER SET UNICODE CASESPECIFIC,
                     category_guid VARCHAR(64) CHARACTER SET UNICODE CASESPECIFIC,
                     description_length INTEGER,
                     tips INTEGER,
                     yelp_reviews INTEGER,
                     yelp_rating INTEGER,
                     ta_reviews INTEGER,
                     ta_rating INTEGER,
                     yahoo_reviews INTEGER,
                     yahoo_rating INTEGER,
                     google_reviews INTEGER,
                     google_rating INTEGER,
                     ranking INTEGER,
                     score DECIMAL(10,5),
                     source_url VARCHAR(512) CHARACTER SET UNICODE CASESPECIFIC,
                     location_guid VARCHAR(64) CHARACTER SET UNICODE CASESPECIFIC
                )' 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
            <dependent name='dropTable temp'/>
            <dependent name='prepare seo deal inventory'/>            
        </dependencies>
    </job>
         
    <job name="twbrmcp" type="executeBash" command="twbrmcp @parameter_user" 
                            region="na" onerror="ignore">
        <parameters>
            <keyvalue key="user" value="juicer"/>
        </parameters>
    </job>
        
    <job name="load data to tmp table" type="executeBash" 
         command="tdload -h @parameter_tdwc -u vparonyan -p LetsDoTDWC12 
                  -f /tmp/agml_report_out.txt -d TAB 
                  -t agml_merchants_report_tmp --TargetWorkingDatabase sandbox" 
         region="na">
        <parameters>
            <keyvalue key="tdwc" value="tdwc"/>
            <keyvalue key="date" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='twbrmcp'/>
            <dependent name='dropTable log'/>
            <dependent name='dropTable UV'/>
            <dependent name='dropTable ET'/>
            <dependent name='create temp table temp'/>
        </dependencies>
    </job>

    <job name="truncate the main table for current day" type="executeSimpleQuery" 
         command="delete from sandbox.agml_merchants_report where day_key=@parameter_date"
         region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='load data to tmp table'/>
        </dependencies>
    </job>
    
    <job name="move from temporary" type="executeSimpleQuery" 
         command="insert into sandbox.agml_merchants_report select @parameter_date, a.* from sandbox.agml_merchants_report_tmp a" 
         region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='truncate the main table for current day'/>
        </dependencies>
    </job>
             
    <job name="grant select data table" type="executeSimpleQuery" command="grant_select_on_table" 
                            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dbname" value="sandbox"/>
            <keyvalue key="tablename" value="agml_merchants_report"/>
        </parameters>
        <dependencies>
            <dependent name='move from temporary'/>
        </dependencies>
    </job>

</Knowledge_base>

