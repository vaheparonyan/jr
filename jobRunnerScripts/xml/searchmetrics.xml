<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Knowledge_base>
    <job name="sed. update the csv file" type="executeBash" command="sed @parameter_sed_expression ./csv/@parameter_file &#62; ./csv/.@parameter_file" 
                            region="na">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <!--keyvalue key="sed_expression" value="':a;s/^\(\("[^"]*"\|[^",]*\)*\),/\1||||/;ta' -e '1d'"-->
            <keyvalue key="separator" value="||||"/>
            <keyvalue key="sed_expression" value="-e 's/,,,$//g' -e ':a;s/^\(\(&#34;[^&#34;]*&#34;\|[^&#34;,]*\)*\),/\1@parameter_separator/;ta' -e '1d'"/>
            <keyvalue key="file" value="Keyword_Rankings_www.groupon.com_Rankings_@parameter_date.csv"/>
        </parameters>
    </job>
    
    <job nAme="dropTable log" tYpe="dropTable" comMand="temp_KB_@parameter_date_log" 
         reGion="na" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keYvalue key="date" value="${datekey}"/>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="dropTable UV" type="dropTable" command="temp_KB_@parameter_date_UV" 
         region="na" connectionType="teradata" onerror="Ignore">
        <paraMeters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue Key="TargetDBName" vaLue="sandbox"/>
        </paraMeters>
    </job>
    
    <job name="dropTable ET" type="dropTable" command="temp_KB_@parameter_date_ET" 
         region="na" connectionType="teradata" onerror="Ignore">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>

    <job name="dropTable temp" type="dropTable" command="temp_KB_@parameter_date" 
         region="na" connectionType="teradata" onerror="Ignore">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="createTable" type="createTable" command="temp_KB_@parameter_date" 
                            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue key="TargetDBName" value="sandbox"/>
            <keyvalue key="TableIndex" value="PRIMARY INDEX(a01, a03, a05, a06)"/>
        </parameters>
        <columns>
            <column name="a01" description="keyword" type="VARCHAR(100)"/>
            <column name="a02" description="URL" type="VARCHAR(600)"/>
            <column name="a03" description="Pos" type="INTEGER"/>
            <column name="a04" description="Trend" type="INTEGER"/>
            <column name="a05" description="Tags" type="VARCHAR(100)"/>
            <column name="a06" description="Ttl" type="VARCHAR(200)"/>
            <column name="a07" description="USI" type="VARCHAR(100)"/>
            <column name="a08" description="Volume" type="INTEGER"/>
            <column name="a09" description="Traffic" type="INTEGER"/>
            <column name="a10" description="CPC" type="INTEGER"/>
            <!--column name="a11" description="date" type="VARCHAR(100)"/-->
        </columns>
        <dependencies>
            <dependent name='dropTable log'/>
            <dependent name='dropTable UV'/>
            <dependent name='dropTable ET'/>
            <dependent name='dropTable temp'/>
        </dependencies>
    </job>
    
    <job name="twbrmcp" type="executeBash" command="twbrmcp @parameter_user" 
                            region="int" onerror="Ignore">
        <parameters>
            <keyvalue key="user" value="vparonyan"/>
        </parameters>
    </job>
    
    <job name="tdload" type="executeBash" command="tdload -h @parameter_host -u @parameter_user -p @parameter_password 
                                    -f ./csv/.@parameter_datafilename -d @parameter_separator 
                                    -t @parameter_table_name --TargetWorkingDatabase @parameter_schema" 
                            region="na">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue key="host" value="10.20.88.35"/>
            <keyvalue key="user" value="vparonyan"/>
            <keyvalue key="schema" value="sandbox"/>
            <keyvalue key="password" value="LetsDoTDWC12"/>
            <keyvalue key="datafilename" value="Keyword_Rankings_www.groupon.com_Rankings_@parameter_date.csv"/>            
            <keyvalue key="separator" value="&#34;||||&#34;"/>
            <keyvalue key="table_name" value="temp_KB_@parameter_date"/>
        </parameters>
        <dependencies>
            <!--dependent name='twbrmcp'/-->
            <dependent name='createTable'/>
            <dependent name='sed. update the csv file'/>
        </dependencies>
    </job>
    
    <job name="null to value" type="executeSimpleQuery" 
                                          command="UPDATE @parameter_temp_table 
                                                   set a03 = COALESCE(a03, '@parameter_instead_of_null')" 
                            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue key="temp_table" value="sandbox.temp_KB_@parameter_date"/>
            <keyvalue key="instead_of_null" value="200"/>
        </parameters>
        <dependencies>
            <dependent name='tdload'/>
        </dependencies>
    </job>
    
    <job name="searchmetrics_move_from_temporary" type="executeSimpleQuery" command="searchmetrics_move_from_temporary" 
                            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
            <keyvalue key="TargetTableName" value="sandbox.kb_searchmetrics_report"/>
            <keyvalue key="SourceTableName" value="sandbox.temp_KB_@parameter_date"/>
        </parameters>
        <dependencies>
            <dependent name='null to value'/>
        </dependencies>
    </job>

    <job name="grant_select_on_table" type="executeSimpleQuery" command="grant_select_on_table" 
                            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dbname" value="sandbox"/>
            <keyvalue key="tablename" value="kb_searchmetrics_report"/>
        </parameters>
        <dependencies>
            <dependent name='searchmetrics_move_from_temporary'/>
        </dependencies>
    </job>
    
    <job name="create monthly view" type="executeSimpleQuery" 
         command="replace view sandbox.kb_searchmetrics_monthly as
                    select 
                      datekey/100 as month_key,
                      keyword as keyword,
                      avg(pos) as avg_position,
                      avg(trend) as avg_trend,
                      avg(traffic) as avg_traffic,
                      avg(cpc) as avg_cpc
                    from sandbox.kb_searchmetrics_report
                    group by month_key, keyword" 
          region="na" connectionType="teradata">
        <parameters>
        </parameters>
        <dependencies>
        </dependencies>
    </job>;
    
</Knowledge_base>
