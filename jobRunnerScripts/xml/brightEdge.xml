<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Knowledge_base>

    <job name="get brightEdge data" type="brightEdge" command="internalFunction" region="na">
        <parameters>
            <keyvalue key="start_dt" value="${datekey}"/>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="outFile" value="brightEdgeOut.tsv"/>
        </parameters>
    </job>

    <job name="dropTable log" type="dropTable" command="temp_KB_brightEdge_log" 
         region="na" connectionType="teradata" onerror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="dropTable UV" type="dropTable" command="temp_KB_brightEdge_UV" 
         region="na" connectionType="teradata" onerror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="dropTable ET" type="dropTable" command="temp_KB_brightEdge_ET" 
         region="na" connectionType="teradata" onerror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>

    <job name="dropTable temp" type="dropTable" command="temp_KB_brightEdge" 
         region="na" connectionType="teradata" onerror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="createTable temp data table" type="executeBash"
         command="tdsql -H @parameter_tdwc -u vparonyan -p LetsDoTDWC12 &#34;
                    CREATE MULTISET TABLE sandbox.temp_KB_brightEdge ,NO FALLBACK ,
                    NO BEFORE JOURNAL,
                    NO AFTER JOURNAL,
                    CHECKSUM = DEFAULT,
                    DEFAULT MERGEBLOCKRATIO
                    (
                        keywords VARCHAR(1024) CHARACTER SET UNICODE CASESPECIFIC,
                        url VARCHAR(2048) CHARACTER SET UNICODE CASESPECIFIC,
                        ranking integer,
                        weekkey integer,
                        searchengine VARCHAR(128) CHARACTER SET UNICODE CASESPECIFIC,
                        country VARCHAR(16) CHARACTER SET UNICODE CASESPECIFIC
                    )
                    PRIMARY INDEX ( weekkey, keywords, url )&#34;" 
            region="na">
        <parameters>
            <keyvalue key="tdwc" value="10.20.88.35"/>
        </parameters>
        <dependencies>
            <dependent name='dropTable log'/>
            <dependent name='dropTable UV'/>
            <dependent name='dropTable ET'/>
            <dependent name='dropTable temp'/>
        </dependencies>
    </job>
    
    <job name="twbrmcp" type="executeBash" command="twbrmcp @parameter_user" 
                            region="int" onerror="Ignore">
        <parameters>
            <keyvalue key="user" value="vparonyan"/>
        </parameters>
    </job>
    
    <job name="tdload" type="executeBash" command="tdload -h @parameter_tdwc -u vparonyan -p LetsDoTDWC12 
                                                    -f brightEdgeOut.tsv
                                                    -d TAB -t temp_KB_brightEdge --TargetWorkingDatabase sandbox" 
                            region="na">
        <parameters>
            <keyvalue key="tdwc" value="10.20.88.35"/>
        </parameters>
        <dependencies>
            <!--dependent name='twbrmcp'/-->
            <dependent name='createTable temp data table'/>
            <dependent name='get brightEdge data'/>
        </dependencies>
    </job>        
    
    <job name="move data from temp data table" type="executeBash"
         command="tdsql -H 10.20.88.35 -u vparonyan -p LetsDoTDWC12 &#34;
                    insert into sandbox.kb_seo_brightedge( monthkey, keywords, url, ranking, weekkey, searchengine, country) 
                    select 0, keywords, url, ranking, weekkey, searchengine, country from sandbox.temp_KB_brightEdge&#34;"
            region="na">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name="tdload"/>
        </dependencies>
    </job>
    
    <job name="set the month key" type="executeBash"
         command="tdsql -H 10.20.88.35 -u vparonyan -p LetsDoTDWC12 &#34;
                    update t
                    from sandbox.kb_seo_brightedge t, SYS_CALENDAR.Calendar c 
                    set monthkey = c.year_of_calendar*100 + c.month_of_year
                    where c.year_of_calendar = weekkey/100 and c.week_of_year + 1 = weekkey mod 100 and c.day_of_week = 5&#34;"
            region="na">
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name="move data from temp data table"/>
        </dependencies>
    </job>
    
    <job name="grant select data table" type="executeSimpleQuery" command="grant_select_on_table" 
                            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dbname" value="sandbox"/>
            <keyvalue key="tablename" value="kb_seo_brightedge"/>
        </parameters>
        <dependencies>
            <dependent name='set the month key'/>
        </dependencies>
    </job>
    
</Knowledge_base>
