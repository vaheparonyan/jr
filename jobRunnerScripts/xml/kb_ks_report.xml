<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Knowledge_base>

    <!--job name="preprocess: create views" type="executeSimpleQuery" 
         command="kb_ks_deal_inventory_data" 
         region="int" connectionType="teradata" >
    </job>
    
    <job name="kb ks locale cities" type="executeSimpleQuery" 
         command="kb_ks_locale_cities" 
         region="int" connectionType="teradata">
        <parameters>
        </parameters>
    </job>

    <job name="get Taxonomies" type="getTaxonomies" 
            command="internalFunction" region="na,int,needish">
        <parameters>
            <keyvalue key="taxonomy_guid" value="2b90adda-524a-47b5-98de-20906b7a766f"/>
            <keyvalue key="outfile" value="/tmp/kb_ks_taxonomies.tsv"/>
        </parameters>
    </job>
    
    <job nAme="dropTable taxonomies log" tYpe="dropTable" comMand="kb_taxonomies_log" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
        
    <job nAme="dropTable taxonomies UV" tYpe="dropTable" comMand="kb_taxonomies_UV" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job nAme="dropTable taxonomies ET" tYpe="dropTable" comMand="kb_taxonomies_ET" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job nAme="dropTable taxonomies" tYpe="dropTable" comMand="kb_taxonomies" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
    </job>
    
    <job name="create taxonomy table" type="executeSimpleQuery" 
         command="CREATE MULTISET TABLE sandbox.kb_taxonomies ,NO FALLBACK ,
                        NO BEFORE JOURNAL,
                        NO AFTER JOURNAL,
                        CHECKSUM = DEFAULT,
                        DEFAULT MERGEBLOCKRATIO
                        (
                         locale VARCHAR(5) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         category_name VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         description VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
                         taxonomy_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
                         child_count INTEGER,
                         parent VARCHAR(36) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         depth INTEGER,
                         friendly_namePlural VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         permalink VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         seo_name VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         friendly_name_short VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         friendly_name VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         friendly_name_singular VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         friendly_name_title VARCHAR(128) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         relationships_size INTEGER)
                   PRIMARY INDEX ( locale ,category_name ,guid ,friendly_name_title )" 
         region="int" connectionType="teradata">
        <parameters>
        </parameters>
    <dependencies>
        <dependent name='dropTable taxonomies log'/>
        <dependent name='dropTable taxonomies UV'/>
        <dependent name='dropTable taxonomies ET'/>
        <dependent name='dropTable taxonomies'/>
        </dependencies>
    </job>
    
    <job name="load taxonomies" type="executeBash" 
         command="tdload -h @parameter_host -u @parameter_user -p @parameter_password 
                    -f ./csv/.@parameter_datafilename -d @parameter_separator 
                    -t @parameter_table_name -\-TargetWorkingDatabase @parameter_schema" 
        region="int">
        <parameters>
            <keyvalue key="host" value="tdwb"/>
            <keyvalue key="user" value="vparonyan"/>
            <keyvalue key="schema" value="sandbox"/>
            <keyvalue key="password" value="LetsDoTDWB12"/>
            <keyvalue key="datafilename" value="/tmp/kb_ks_taxonomies.tsv"/>            
            <keyvalue key="separator" value="&#34;TAB&#34;"/>
            <keyvalue key="table_name" value="kb_taxonomies"/>
        </parameters>
        <dependencies>
            <dependent name='create taxonomy table'/>
            <dependent name='get Taxonomies'/>
        </dependencies>
        
        CREATE MULTISET TABLE sandbox.kb_taxonomies_hier ,NO FALLBACK ,
        NO BEFORE JOURNAL,
        NO AFTER JOURNAL,
        CHECKSUM = DEFAULT,
        DEFAULT MERGEBLOCKRATIO
        (
         guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
         l1_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
         l2_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
         l3_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
         l4_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
         l5_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC,
         l6_guid VARCHAR(36) CHARACTER SET UNICODE CASESPECIFIC
		)
   PRIMARY INDEX ( guid);
   
delete from sandbox.kb_taxonomies_hier;

insert into  sandbox.kb_taxonomies_hier
select distinct guid, null, null, null, null, null, null from sandbox.kb_taxonomies;

replace view sandbox.vpa_tx_zzzz as
select distinct guid, parent from  sandbox.kb_taxonomies where depth = 4 ;

update sandbox.kb_taxonomies_hier from (
select guid as l0_guid, parent as l_parent from sandbox.vpa_tx_zzzz ) t
set l3_guid = l_parent
where guid = l0_guid;

replace view sandbox.vpa_tx_zzzz as
select distinct guid, parent from  sandbox.kb_taxonomies where depth = 3 ;

update sandbox.kb_taxonomies_hier from (
select guid as l0_guid, parent as l_parent from sandbox.vpa_tx_zzzz ) t
set l2_guid = l_parent
where guid = l0_guid;

update sandbox.kb_taxonomies_hier from (
select guid as l0_guid, parent as l_parent from sandbox.vpa_tx_zzzz ) t
set l2_guid = l_parent
where l3_guid = l0_guid;


replace view sandbox.vpa_tx_zzzz as
select distinct guid, parent from  sandbox.kb_taxonomies where depth = 2 ;

update sandbox.kb_taxonomies_hier from (
select guid as l0_guid, parent as l_parent from sandbox.vpa_tx_zzzz ) t
set l1_guid = l_parent
where guid = l0_guid;

update sandbox.kb_taxonomies_hier from (
select guid as l0_guid, parent as l_parent from sandbox.vpa_tx_zzzz ) t
set l1_guid = l_parent
where l2_guid = l0_guid;

select t.category_name as n, t1.category_name as l1, t2.category_name as l2, t3.category_name as l3, t4.category_name as l4 from sandbox.kb_taxonomies_hier h
left join sandbox.kb_taxonomies t on
h.guid = t.guid
left join sandbox.kb_taxonomies t1 on
h.l1_guid = t1.guid and t.locale = t1.locale
left join sandbox.kb_taxonomies t2 on
h.l2_guid = t2.guid and t.locale = t2.locale
left join sandbox.kb_taxonomies t3 on
h.l3_guid = t3.guid and t.locale = t3.locale
left join sandbox.kb_taxonomies t4 on
h.l4_guid = t4.guid and t.locale = t4.locale
where t.locale = 'en_US';

    </job-->

    <!--job name="kb ks taxonomy patches" type="executeSimpleQuery" 
         command="kb_ks_taxonomy_patches" 
         region="int" connectionType="teradata">
        <parameters>
        </parameters>
         <dependencies>
            <! - -dependent name='load taxonomies'/- ->
        </dependencies>
    </job-->
    
    <job name="droptable kb_ks_keywords" tYpe="dropTable" comMand="kb_ks_keywords" 
         reGion="na" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
            <!--dependent name='kb ks locale cities'/-->
        </dependencies>
    </job>
    
    <job name="create kb_ks_keywords" tYpe="executeSimpleQuery" 
         comMand="CREATE SET TABLE sandbox.kb_ks_keywords ,NO FALLBACK ,                                                                                                                                    
                        NO BEFORE JOURNAL,                                                                                                                                                                   
                        NO AFTER JOURNAL,                                                                                                                                                                    
                        CHECKSUM = DEFAULT,                                                                                                                                                                  
                       DEFAULT MERGEBLOCKRATIO                                                                                                                                                              
                       (
                        locale VARCHAR(5) CHARACTER SET UNICODE NOT CASESPECIFIC,                                                                                                                           
                        keyword VARCHAR(1024) CHARACTER SET UNICODE NOT CASESPECIFIC,
                        friendly_name_title VARCHAR(1024) CHARACTER SET UNICODE NOT CASESPECIFIC,   
                        city VARCHAR(1024) CHARACTER SET UNICODE NOT CASESPECIFIC,   
                        query_pattern VARCHAR(1024) CHARACTER SET UNICODE NOT CASESPECIFIC)                                                                                                                 
                   PRIMARY INDEX ( locale, keyword, query_pattern)" 
         reGion="na" conNectionType="teradata">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='droptable kb_ks_keywords'/>
        </dependencies>
    </job>
    
    <job name="insert keyword_templates" tYpe="executeSimpleQuery" 
         comMand="kb_ks_keyword_templates" 
         reGion="na" conNectionType="teradata">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='create kb_ks_keywords'/>
        </dependencies>
    </job>
    
    <job name="dump kb ks keywords" type="executeBash" 
         command="mkdir -p keywords dump; 
                  rm -rf ./keywords/* ./dump/*; 
                  tdsql -H tdwb -u vparonyan -p LetsDoTDWB12 -c UTF8 'select locale, keyword from sandbox.kb_ks_keywords' &#62; ./keywords/keywords.txt" 
         region="na">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='insert keyword_templates'/>
        </dependencies>
    </job>

    <job name="google ads keywords stats" type="keywordStats" 
            command="internalFunction" region="na">
        <parameters>
            <keyvalue key="infile" value="./keywords/keywords.txt"/>
            <keyvalue key="outfile" value="./dump/keywords.txt"/>
            <keyvalue key="start_dt" value="${datekey}"/>
            <keyvalue key="end_dt" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='dump kb ks keywords'/>
        </dependencies>
    </job>
    
    <job name="droptable kb_ks_google_potential_UV" tYpe="dropTable" comMand="kb_ks_google_potential_UV" 
         reGion="na" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>
    
    <job name="droptable kb_ks_google_potential_ET" tYpe="dropTable" comMand="kb_ks_google_potential_ET" 
         reGion="na" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>
    
    <job name="droptable kb_ks_google_potential_log" tYpe="dropTable" comMand="kb_ks_google_potential_log" 
         reGion="na" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>
    
    <job name="clean google stats table" type="executeSimpleQuery" 
         command="delete from sandbox.kb_ks_google_potential" 
         region="na" connectionyype="teradata">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='google ads keywords stats'/>
            <dependent name='droptable kb_ks_google_potential_log'/>
            <dependent name='droptable kb_ks_google_potential_UV'/>
            <dependent name='droptable kb_ks_google_potential_ET'/>
        </dependencies>
    </job>
    
    <job name="load google stats" type="executeBash" 
         command="tdload -h @parameter_host -u @parameter_user -p @parameter_password 
                    -f ./dump/keywords.txt -d @parameter_separator -c UTF8
                    -t @parameter_table_name --TargetWorkingDatabase @parameter_schema" 
        region="na">
        <parameters>
            <keyvalue key="host" value="tdwb"/>
            <keyvalue key="user" value="vparonyan"/>
            <keyvalue key="schema" value="sandbox"/>
            <keyvalue key="password" value="LetsDoTDWB12"/>         
            <keyvalue key="separator" value="&#34;TAB&#34;"/>
            <keyvalue key="table_name" value="kb_ks_google_potential"/>
        </parameters>
        <dependencies>
            <dependent name='clean google stats table'/>
        </dependencies>
    </job>
        
    <job name="clean kb ks keywords" type="executeBash" 
         command="rm -rf ./keywords ./dump" 
         region="int">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='load google stats'/>
        </dependencies>
    </job>
    
    <job name="kb ks final report" type="executeSimpleQuery" 
         comMand="kb_ks_final_report" 
         reGion="int" conNectionType="teradata">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='load google stats'/>
            <dependent name='insert keyword_templates'/>
        </dependencies>
    </job>




    <job name="dump kb ks for keyword ideas" type="executeBash" 
         command="mkdir -p keywords dump; 
                  rm -rf ./keywords/* ./dump/*; 
                  tdsql -H tdwb -u vparonyan -p LetsDoTDWB12 -c UTF8 'select locale, keyword_string from sandbox.kb_ks_report_final' &#62; ./keywords/keywords.txt" 
         region="int">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='kb ks final report'/>
        </dependencies>
    </job>
    
    <job name="droptable kb_ks_keyword_ideas" tYpe="dropTable" comMand="kb_ks_keyword_ideas" 
         reGion="int" conNectionType="teradata">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
            <dependent name='dump kb ks for keyword ideas'/>
        </dependencies>
    </job>
    
    <job nAme="create kb_ks_keyword_ideas" tYpe="executeSimpleQuery" 
         comMand="CREATE MULTISET TABLE sandbox.kb_ks_keyword_ideas ,NO FALLBACK ,
                        NO BEFORE JOURNAL,
                        NO AFTER JOURNAL,
                        CHECKSUM = DEFAULT,
                        DEFAULT MERGEBLOCKRATIO
                        (
                         locale VARCHAR(5) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         keyword_string VARCHAR(1048) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         suggested_keyword_string VARCHAR(1048) CHARACTER SET UNICODE NOT CASESPECIFIC,
                         suggested_search_volume INTEGER,
                         suggested_average_cpc DECIMAL(5,2),
                         suggested_competition DECIMAL(5,2))
                   PRIMARY INDEX ( locale ,keyword_string, suggested_keyword_string )" 
         reGion="int" conNectionType="teradata">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='droptable kb_ks_keyword_ideas'/>
        </dependencies>
    </job>
    
    <job name="google ads keywords ideas" type="keywordStats" 
            command="internalFunction" region="na,int,needish">
        <parameters>
            <keyvalue key="infile" value="./keywords/keywords.txt"/>
            <keyvalue key="outfile" value="./dump/keywords.txt"/>
            <keyvalue key="start_dt" value="${datekey}"/>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="type" value="IDEAS"/>
        </parameters>
        <dependencies>
            <dependent name='dump kb ks for keyword ideas'/>
        </dependencies>
    </job>
        
    <job nAme="droptable kb_ks_keyword_ideas_UV" tYpe="dropTable" comMand="kb_ks_keyword_ideas_UV" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>
    
    <job nAme="droptable kb_ks_keyword_ideas_ET" tYpe="dropTable" comMand="kb_ks_keyword_ideas_ET" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>
    
    <job nAme="droptable kb_ks_keyword_ideas_log" tYpe="dropTable" comMand="kb_ks_keyword_ideas_log" 
         reGion="int" conNectionType="teradata" oneRror="Ignore">
        <parameters>
            <keyvalue key="TargetDBName" value="sandbox"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>
    
    <job name="load google ideas" type="executeBash" 
         command="tdload -h @parameter_host -u @parameter_user -p @parameter_password 
                    -f ./dump/keywords.txt -d @parameter_separator -c UTF8
                    -t @parameter_table_name --TargetWorkingDatabase @parameter_schema" 
        region="int">
        <parameters>
            <keyvalue key="host" value="tdwb"/>
            <keyvalue key="user" value="vparonyan"/>
            <keyvalue key="schema" value="sandbox"/>
            <keyvalue key="password" value="LetsDoTDWB12"/>         
            <keyvalue key="separator" value="&#34;TAB&#34;"/>
            <keyvalue key="table_name" value="kb_ks_keyword_ideas"/>
        </parameters>
        <dependencies>
            <dependent name='google ads keywords ideas'/>
            <dependent name='create kb_ks_keyword_ideas'/>
            <dependent name='droptable kb_ks_keyword_ideas_log'/>
            <dependent name='droptable kb_ks_keyword_ideas_UV'/>
            <dependent name='droptable kb_ks_keyword_ideas_ET'/>
        </dependencies>
    </job>    
  
        
    <job name="kb ks send final report" type="executeBash" 
         command="./shell/kb_ks_send_final_report.sh" 
         region="int">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='load google ideas'/>
        </dependencies>
    </job>
    
    
</Knowledge_base>
