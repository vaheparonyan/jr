<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Knowledge_base>

   <ResultSet name="int_bld_session_metrics_fcs" region="int" >
        <column type="integer" name="event_day_key"/>
        <column type="integer" name="page_country_key"/>
        <column type="integer" name="mktg_ref_key"/>
        <column type="varchar" name="platform"/>
        <column type="varchar" name="browser_type"/>
        <column type="varchar" name="query_type"/>
        <column type="varchar" name="page_channel"/>
        <column type="varchar" name="page_type"/>
        <column type="varchar" name="experiment"/>
        <column type="varchar" name="variant"/>
        <column type="varchar" name="layer"/>       
        <column type="varchar" name="url_pattern"/>
        <column type="integer" name="visitors"/>
        <column type="integer" name="sessions"/>
        <column type="integer" name="bounce_sessions"/>        
        <column type="integer" name="order_sessions"/>
        <column type="integer" name="page_views"/>
        <column type="integer" name="page_views_on_orders"/>
        <column type="integer" name="average_session_length"/>
        <column type="integer" name="transactions"/>
        <column type="double" name="bookings"/>
        <column type="double" name="revenue"/>
        <column type="integer" name="new_subscribers"/>
        <column type="integer" name="new_subscription_requests"/>
        <column type="integer" name="new_subscriptions"/>              
    </ResultSet>

    <job name="check number of rows by datekey" type="executeSimpleQuery" 
            command="select count(*) from dwh_mart_view.v_billings_ini_successful where cast(cast(created_at as date) as integer)+19000000 = @parameter_date" 
         region="int" connectionType="teradata" onerror="retry" retry="60" retryperiod="900">
        <asserter datatype="integer" column="1" condition="greater" value="110000" />
        <parameters>
            <keyvalue key="date" value="${datekey}"/>
        </parameters>
    </job>
    
    <job name="check number of rows by date" type="executeSimpleQuery" 
            command="select count(*) from dwh_mart_view.fact_clickstream where event_date = '@parameter_date'" 
         region="int" connectionType="teradata" onerror="retry" retry="60" retryperiod="900">
        <asserter datatype="integer" column="1" condition="greater" value="15000000" />
        <parameters>
            <keyvalue key="date" value="${date}"/>
        </parameters>
    </job>
    
    <job name="truncate teradata table" type="executeSimpleQuery" 
            command="delete from sandbox.as_int_bld_session_metrics_fcs where event_day_key = @parameter_dtkey" 
            region="int" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name="check number of rows by date"/>
            <dependent name="check number of rows by datekey"/>
        </dependencies> 
    </job>
    
    <job name="load int bld session table fcs" type="executeSimpleQuery" 
            command="load_int_bld_session_table_fcs" 
            region="int" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name="truncate teradata table"/>
        </dependencies> 
    </job>

    <job name="load int experiments cube" type="executeSimpleQuery" 
            command="load_int_bld_session_experiments"
            region="int" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name="load int bld session table fcs"/>
        </dependencies>
    </job>

    <job name="truncate ex my sql" type="executeSimpleQuery" 
            command="delete from seo_analytics.@parameter_MYSQL_TABLENAME where event_day_key = @parameter_dtkey" 
            region="int" connectionType="mysql">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="MYSQL_TABLENAME" value="int_bld_session_experiments_fcs"/>

            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1"/>
            <keyvalue key="TargetDBUser" value="seo_juicer"/>
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
        </parameters>
        <dependencies>
        </dependencies>
    </job>

    <job name="load ex mysql" type="executeQuery" 
         command="select * from sandbox.@parameter_TD_TABLENAME where event_day_key = @parameter_dtkey"
         region="int" connectionType="teradata">
        <parameters type="queryParameter">
            <keyvalue key="TD_TABLENAME" value="int_bld_session_expt_metrics"/>
            <keyvalue key="dtkey" value="${datekey}"/>

            <!--keyvalue key="TargetDBURL" value="localhost"/-->
            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1" />
            <keyvalue key="TargetDBUser" value="seo_juicer"/>
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
            <keyvalue key="TargetDBName" value="seo_analytics"/>
        </parameters>

        <resultSet connectionType="mysql" name="int_bld_session_metrics_fcs">
            <!--column  sourceColumn="name" targetColumn="name"</column-->
        </resultSet>

        <dependencies>
            <dependent name="truncate ex my sql"/>
        </dependencies>
    </job>

    <job name="create seo int experiments cube" type="executeSimpleQuery" 
            command="cube_int_bld_session_experiments" 
            region="int" connectionType="mysql">
        <parameters>

            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1"/>
            <keyvalue key="TargetDBUser" value="seo_juicer"/>
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
            <keyvalue key="TargetDBName" value="seo_analytics"/>
        </parameters>

        <dependencies>
            <dependent name="load ex mysql"/>
        </dependencies>

    </job>


    <job name="truncate my sql" type="executeSimpleQuery" 
            command="delete from seo_analytics.@parameter_MYSQL_TABLENAME where event_day_key = @parameter_dtkey" 
            region="int" connectionType="mysql">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="MYSQL_TABLENAME" value="int_bld_session_metrics_fcs"/>
            
            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1"/> 
            <keyvalue key="TargetDBUser" value="seo_juicer"/> 
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
        </parameters>
        <dependencies>
            <dependent name="check number of rows by date"/>
            <dependent name="check number of rows by datekey"/>
        </dependencies> 
    </job>
    
    <job name="create int RP cube" type="executeBash" 
            command="java -Djava.security.egd=file:/dev/./urandom -jar /var/groupon/apps/job_runner/jobRunner/current/dist/Job-runner.jar -env production -region intl -start_day @parameter_date -end_day 2999-12-12 -jobs seo_int_request_path_cube.xml -date_range true"
            region="int"> 
        <parameters>

            <keyvalue key="date" value="${date}"/>
        </parameters>
    
        <dependencies>
            <dependent name="load int bld session table fcs"/>
        </dependencies>

    </job>



     <job name="load mysql" type="executeQuery" 
         command="select * from sandbox.@parameter_TD_TABLENAME where event_day_key = @parameter_dtkey"
         region="int" connectionType="teradata"> 
        <parameters type="queryParameter">
            <keyvalue key="TD_TABLENAME" value="as_int_bld_session_metrics_fcs"/>
            <keyvalue key="dtkey" value="${datekey}"/>

            <!--keyvalue key="TargetDBURL" value="localhost"/-->
            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1" />
            <keyvalue key="TargetDBUser" value="seo_juicer"/>
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
            <keyvalue key="TargetDBName" value="seo_analytics"/>
        </parameters>

        <resultSet connectionType="mysql" name="int_bld_session_metrics_fcs">
            <!--column  sourceColumn="name" targetColumn="name"</column-->
        </resultSet>
         
        <dependencies>
            <dependent name="truncate my sql"/>
            <dependent name="load int bld session table fcs"/>     
        </dependencies>   
    </job>


    <job name="create seo int operational cube" type="executeSimpleQuery" 
            command="seo_int_operational_cube" 
            region="int" connectionType="mysql">
        <parameters>

            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1"/>
            <keyvalue key="TargetDBUser" value="seo_juicer"/>
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
            <keyvalue key="TargetDBName" value="seo_analytics"/>
        </parameters>
    
        <dependencies>
            <dependent name="load mysql"/>
        </dependencies>

    </job>
    
</Knowledge_base>
