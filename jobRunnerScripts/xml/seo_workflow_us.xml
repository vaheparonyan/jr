<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Knowledge_base>

    <job name="check number of rows by datekey 1" type="executeSimpleQuery" 
            command="select count(*) from user_groupondw.fact_orders where order_date_key = @parameter_dtkey"
         region="na" connectionType="teradata" onerror="retry" retry="60" retryperiod="900">
        <asserter datatype="integer" column="1" condition="greater" value="150000" />
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
    </job>
    
    <job name="check number of rows by datekey 2" type="executeSimpleQuery" 
            command="select count(*) from user_groupondw.fact_collections where order_date_key = @parameter_dtkey" 
         region="na" connectionType="teradata" onerror="retry" retry="60" retryperiod="900">
        <asserter datatype="integer" column="1" condition="greater" value="150000" />
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
    </job>
    
    <job name="check number of rows by datekey 3" type="executeSimpleQuery" 
            command="select count(*) from user_groupondw.fact_clickstream where event_type_key = 2 and event_date = cast( (@parameter_dtkey-19000000) as date format 'yyyy-mm-dd');" 
         region="na" connectionType="teradata" onerror="retry" retry="60" retryperiod="900">
        <asserter datatype="integer" column="1" condition="greater" value="5000000" />
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
    </job>
    
    <job name="load na bld session table fcs" type="executeSimpleQuery" 
            command="load_na_bld_session_table_fcs" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name='check number of rows by datekey 1'/>
            <dependent name='check number of rows by datekey 2'/>
            <dependent name='check number of rows by datekey 3'/>
        </dependencies> 
    </job>
    
    <job name="load na bld local metrics fcs" type="executeSimpleQuery" 
            command="load_bld_local_metrics_fcs" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name='load na bld session table fcs'/>
        </dependencies> 
    </job>
    
    <job name="load na bld biz metrics fcs" type="executeSimpleQuery" 
            command="load_bld_biz_metrics_fcs" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name='load na bld local metrics fcs'/>
        </dependencies> 
    </job>
    
    <job name="update deal counts" type="executeSimpleQuery" 
            command="update_deal_counts" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='load na bld biz metrics fcs'/>
        </dependencies> 
    </job>
    
    <job name="load bld session exp metrics fcs" type="executeSimpleQuery" 
            command="load_bld_session_exp_metrics_fcs" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name='update deal counts'/>
        </dependencies> 
    </job>
    
     <job name="load bot view test metrics" type="executeSimpleQuery" 
            command="load_bot_view_test_metrics" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name='load bld session exp metrics fcs'/>
        </dependencies> 
    </job>
    
    <job name="load seo url metrics" type="executeSimpleQuery" 
            command="load_seo_url_metrics" 
            region="na" connectionType="teradata">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
        </parameters>
        <dependencies>
            <dependent name='load bot view test metrics'/>
        </dependencies> 
    </job>
    
    <!--job name="update_seo_cube_bh" type="executeBash"
         command="~/groupon-seo-admin/script/ddl/update_seo_cube_bh -df @parameter_dtkey -dt @parameter_end_dt" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='load na bld session table fcs'/>
        </dependencies>
    </job-->
    
    <job name="copy_subset_to_mysql as_bld_session_metrics_fcs" type="executeBash"
         command="~/groupon-seo-admin/script/copy_subset_to_mysql as_bld_session_metrics_fcs event_day_key @parameter_dtkey @parameter_end_dt bld_session_metrics_fcs" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='load seo url metrics'/>
        </dependencies>
    </job>
    
    <job name="copy_subset_to_mysql fact_article_page_metrics" type="executeBash"
         command="~/groupon-seo-admin/script/copy_subset_to_mysql fact_article_page_metrics log_date_key @parameter_dtkey @parameter_end_dt" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='copy_subset_to_mysql as_bld_session_metrics_fcs'/>
        </dependencies>
    </job>
    
    <job name="copy_to_mysql as_deals_launched_count" type="executeBash"
         command="~/groupon-seo-admin/script/copy_to_mysql as_deals_launched_count deals_launched_count" 
            region="na">
        <parameters>
        </parameters>
        <dependencies>
            <dependent name='copy_subset_to_mysql fact_article_page_metrics'/>
        </dependencies>
    </job>
    
    <job name="copy_subset_to_mysql as_bld_local_metrics_fcs" type="executeBash"
         command="~/groupon-seo-admin/script/copy_subset_to_mysql as_bld_local_metrics_fcs event_day_key @parameter_dtkey @parameter_end_dt bld_local_metrics_fcs" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='copy_to_mysql as_deals_launched_count'/>
        </dependencies>
    </job>

    <job name="copy_subset_to_mysql as_bld_local_metrics_fcs" type="executeBash"
         command="~/groupon-seo-admin/script/copy_subset_to_mysql as_bld_biz_metrics_fcs event_day_key @parameter_dtkey @parameter_end_dt bld_biz_metrics_fcs" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='copy_subset_to_mysql as_bld_local_metrics_fcs'/>
        </dependencies>
    </job>
    
    <job name="copy_subset_to_mysql as_bld_session_exp_metrics_fcs" type="executeBash"
         command="~/groupon-seo-admin/script/copy_subset_to_mysql as_bld_session_exp_metrics_fcs event_day_key @parameter_dtkey @parameter_end_dt bld_session_exp_metrics_fcs" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='copy_subset_to_mysql as_bld_local_metrics_fcs'/>
        </dependencies>
    </job>
    
    <job name="copy_subset_to_mysql as_bot_view_test_metrics" type="executeBash"
         command="~/groupon-seo-admin/script/copy_subset_to_mysql as_bot_view_test_metrics event_day_key ${bh_date_from} ${date_to} @parameter_dtkey @parameter_end_dt bot_view_test_metrics" 
            region="na">
        <parameters>
            <keyvalue key="end_dt" value="${datekey}"/>
            <keyvalue key="dtkey" value="${datekey}"/>
        </parameters>
        <dependencies>
            <dependent name='copy_subset_to_mysql as_bld_session_exp_metrics_fcs'/>
        </dependencies>
    </job>

    <job name="create seo na operational cube" type="executeSimpleQuery" 
            command="seo_na_operational_cube" 
            region="na" connectionType="mysql">
        <parameters>
            <keyvalue key="dtkey" value="${datekey}"/>
            <keyvalue key="date" value="${date}"/>
            <keyvalue key="TargetDBURL" value="marketing-analytics-db-master-vip.snc1"/>
            <keyvalue key="TargetDBUser" value="seo_juicer"/>
            <keyvalue key="TargetDBPassword" value="seo_juicer"/>
            <keyvalue key="TargetDBName" value="seo_analytics"/>
        </parameters>
        <dependencies>
            <dependent name='copy_subset_to_mysql as_bot_view_test_metrics'/>
        </dependencies>
    </job>



</Knowledge_base>
